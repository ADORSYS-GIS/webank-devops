# Helm Chart Release Workflow

This document describes the GitHub Actions workflow used to automate the release of Helm charts for the project.

## Workflow File: `.github/workflows/release.yml`

### Workflow Overview

The **Release Charts** workflow is triggered whenever changes are pushed to the `main` branch. It automates the following steps:
1. Checks out the repository.
2. Configures Git with the actor's credentials.
3. Installs Helm and configures repositories.
4. Uses the Helm Chart Releaser to publish updated charts.

### Workflow YAML Breakdown

#### **Trigger**

The workflow is triggered on `push` events to the `main` branch:
```yaml
on:
  push:
    branches:
      - main
```

#### **Job: `release`**

##### **Permissions**
The workflow requires `write` permissions for the `contents` scope to create or update the charts:
```yaml
permissions:
  contents: write
```

##### **Environment**
The workflow runs on `ubuntu-latest` virtual environment:
```yaml
runs-on: ubuntu-latest
```

#### **Steps**

1. **Checkout the Repository**
   - Fetches the repository with full history (`fetch-depth: 0` ensures all tags are available):
   ```yaml
   - name: Checkout
     uses: actions/checkout@v3
     with:
       fetch-depth: 0
   ```

2. **Configure Git**
   - Sets the Git user name and email to match the actor triggering the workflow:
   ```yaml
   - name: Configure Git
     run: |
       git config user.name "$GITHUB_ACTOR"
       git config user.email "$GITHUB_ACTOR@users.noreply.github.com"
   ```

3. **Install Helm**
   - Installs Helm using the `azure/setup-helm` action and authenticates using the `GITHUB_TOKEN` secret:
   ```yaml
   - name: Install Helm
     uses: azure/setup-helm@v4
     env:
       GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
   ```

4. **Add Helm Repositories**
   - Adds external Helm chart repositories (`bitnami`) and updates the repository index:
   ```yaml
   - name: Add repos to Helm
     run: |
       helm repo add bitnami https://charts.bitnami.com/bitnami
       helm repo add webank https://ADORSYS-GIS.github.io/webank-devops
       helm repo update
   ```

5. **Run Chart Releaser**
   - Publishes updated Helm charts to GitHub Pages using the `helm/chart-releaser-action`:
   ```yaml
   - name: Run chart-releaser
     uses: helm/chart-releaser-action@v1.6.0
     env:
       CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
   ```

### Prerequisites

1. **GitHub Repository Setup**
   - Ensure the repository contains a `charts` directory with properly structured Helm charts.

2. **Secrets**
   - Add `GITHUB_TOKEN` to your repository secrets. This is provided automatically by GitHub Actions.

3. **GitHub Pages**
   - Enable GitHub Pages on the repository for the branch where chart releases will be published (e.g., `gh-pages`).

4. **A Github Pages branch active**
   - The chart releaser action used in the workflow to release helm chart artifacts looks for a branch called *gh-pages* by default. So the branch should be created before running the workflow.

### Accessing our deployed Helm charts

Once the Helm charts are released using this workflow, they are hosted as static files on the `gh-pages` branch of the repository and made accessible through GitHub Pages. Now let's talk a little on how to access and use the deployed charts.

#### **1. Understanding the `index.yaml` File**
- The `index.yaml` file is automatically generated by the Helm Chart Releaser Action during the release process.
- It serves as the catalog for your Helm repository, containing metadata about the available charts, including their names, versions, and download URLs.
- One way to think about it is that it is what defines a helm repo since, for the reasons mentioned above, helm always looks for this file while working with a repo.
- Helm uses this `index.yaml` file to fetch information about the charts when users run `helm repo add` or `helm search`.

#### **2. GitHub Pages and the `gh-pages` Branch**
- The `gh-pages` branch is used to host the `index.yaml` file and the chart artifacts as a static site.
- GitHub Pages serves the content of this branch at a URL like:  
  `https://<username>.github.io/<repository>/`
  - Replace `<username>` with your GitHub username or organization name.
  - Replace `<repository>` with the name of your GitHub repository.
- Case in point, the url for our webank helm charts at ADORSYS-GIS is
  `https://ADORSYS-GIS.github.io/webank-devops/`

#### **3. Adding the Repository to Helm**
To use the deployed charts, you need to add your Helm repository to your local setup:
```bash
helm repo add webank https://ADORSYS-GIS.github.io/webank-devops/
helm repo update
```

**NOTE:** 'webank' here is an arbitrary name given to each repo you use in your project. You decide what you want to call it for your project

#### **4. Searching and Downloading Charts**
Once the repository is added, you can search for available charts:
```bash
helm search repo webank
```

**NOTE:** Searching here gives you a list of all releases(versions, in some way) of all helm charts(each having a unique chart name) of our project. Once you find the one you want, you may download it as shown next.

To download and use a chart, you can install it directly:
```bash
helm install 'my-release' ADORSYS-GIS.github.io/'chart-name' --version <chart-version>
```
**NOTE:** 'my-release' here is an arbitrary name given to the release you are performing using our helm chart for your project. You decide what you want to call it for your project.
- Replace `<chart-name>` with the name of your chart.
- Replace `<chart-version>` with the version you want to install (or omit it to use the latest version).

#### **5. Benefits of this Setup**
- **Centralized Management**: All released charts are accessible through a single URL.
- **Versioning**: Users can install specific versions of the charts using Helm.
- **Ease of Use**: The `gh-pages` branch and GitHub Pages integration make it simple to share charts publicly or within a team.

#### **6. Updating the Repository**
Whenever you make updates to your charts and push to the `main` branch, the workflow regenerates the `index.yaml` file and publishes the changes to the `gh-pages` branch. Ensure you run:
```bash
helm repo update
```
to refresh your local Helm repository with the latest charts.

### References

- [Helm Chart Releaser Action Documentation](https://github.com/helm/chart-releaser-action)
- [Azure Setup Helm Action Documentation](https://github.com/Azure/setup-helm)
- [GitHub Pages Documentation](https://docs.github.com/pages)